<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Order & Items</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover">
  <link rel="preconnect" href="https://script.google.com" crossorigin>
  <link rel="preconnect" href="https://www.google.com" crossorigin>
  <link rel="preconnect" href="https://ssl.gstatic.com" crossorigin>
  <link rel="dns-prefetch" href="https://script.google.com">
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <!-- Rotate Overlay (portrait-only enforcement) -->
  <div id="rotate-overlay" role="dialog" aria-live="assertive" aria-hidden="true">
    <div class="rotate-card" role="document">
      <svg class="phone-icon" viewBox="0 0 64 64" aria-hidden="true">
        <rect x="16" y="8" width="32" height="48" rx="6" ry="6" fill="none" stroke="currentColor" stroke-width="3"></rect>
        <rect x="20" y="12" width="24" height="40" rx="3" ry="3" fill="currentColor" opacity="0.12"></rect>
        <g class="rotate-arrow">
          <path d="M38 54a18 18 0 1 1 12-5" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round"></path>
          <polyline points="49,44 51,53 42,51" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"></polyline>
        </g>
      </svg>
      <div class="rotate-title">ROTATE TO PORTRAIT</div>
      <div class="rotate-hint">This app works in portrait mode only.</div>
    </div>
  </div>

  <!-- Boot overlay -->
  <div id="bootMask" class="boot-mask" aria-live="polite">
    <div class="boot-card">
      <div class="dots" aria-hidden="true"><span></span><span></span><span></span></div>
      <div class="boot-text">Loading…</div>
      <div class="boot-sub">Preparing order and items</div>
    </div>
  </div>

  <header id="top">
    <div class="title" id="clientName">Loading…</div>
    <div class="subtitle" id="orderInfo"></div>
  </header>

  <main>
    <section id="itemsGrid" class="grid"></section>
    <div id="empty" class="empty" hidden>No data for that order.</div>
  </main>

  <!-- ===== SHEET 1: LIST ===== -->
  <div id="overlay" class="overlay" hidden></div>

  <section id="sheet" class="sheet" role="dialog" aria-modal="true" aria-labelledby="sheetTitle" hidden>
    <div class="sheet__header">
      <button id="sheetBack" class="sheet__back" aria-label="Back">←</button>
      <div class="sheet__title" id="sheetTitle">Selected Item</div>
    </div>

    <div class="sheet__body sheet1-body">
      <button id="btnAdd" class="cta">Add</button>

      <div id="summary" class="summary" aria-live="polite">
        <div><b>Total players:</b> 0</div>
        <div id="summarySizes">Sizes: —</div>
      </div>

      <div id="list" class="list" role="list"></div>
    </div>
  </section>

  <!-- ===== SHEET 2: EDITOR (SIN TÍTULO/HEADER) ===== -->
  <div id="overlay2" class="overlay overlay-strong" hidden></div>

  <section id="editorSheet" class="sheet sheet-editor" role="dialog" aria-modal="true" hidden>
    <!-- cuerpo scrollable -->
    <div class="sheet-scroll">
      <div class="editor-body">
        <div class="editor-inner">
          <div class="field">
            <label for="ePlayer">Player</label>
            <input id="ePlayer" class="input" type="text" placeholder="Enter player name">
          </div>

          <div class="field">
            <label for="eCategory">Category</label>
            <select id="eCategory" class="select">
              <option value="">Select…</option>
              <option value="YOUTH">Youth</option>
              <option value="ADULT">Adult</option>
              <option value="WOMEN">Women</option>
              <option value="STANDARD">Standard</option>
            </select>
          </div>

          <div id="eSizeField" class="field" hidden>
            <label>Size</label>
            <div id="eSizes" class="size-row" role="radiogroup" aria-label="Size"></div>
          </div>

          <div class="field">
            <label for="eNumber">Number</label>
            <input id="eNumber" class="input" type="tel" inputmode="numeric" pattern="[0-9]*" placeholder="e.g., 28">
          </div>

          <div class="field">
            <label for="eName">Name</label>
            <input id="eName" class="input" type="text" placeholder="Custom name">
          </div>

          <div class="field">
            <label>Units</label>
            <div class="qty" role="group" aria-label="Units">
              <button id="qMinus" class="qty__btn" aria-label="Decrease">−</button>
              <input id="eUnits" class="qty__input" type="tel" inputmode="numeric" pattern="[0-9]*" min="1" max="100" value="1">
              <button id="qPlus" class="qty__btn" aria-label="Increase">+</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer ABSOLUTO dentro del sheet (siempre fijo) -->
    <div class="actions-footer" aria-live="polite">
      <div class="actions-inner">
        <div class="actions-row">
          <button id="eDelete" class="action danger" hidden>Delete</button>
        </div>
        <div class="actions-row two">
          <button id="eSave" class="action primary">Save</button>
          <button id="eCancel" class="action">Cancel</button>
        </div>
      </div>
    </div>
  </section>

  <script defer src="app.js"></script>

  <script>
  (function () {
    const html        = document.documentElement;
    const overlay     = document.getElementById('rotate-overlay');
    const editorSheet = document.getElementById('editorSheet');
    const sheet1      = document.getElementById('sheet');
    const pageMain    = document.querySelector('main');
    const pageHeader  = document.querySelector('header');

    // ===== Bloqueo de fondo cuando Sheet 2 está abierto =====
    function lockBackground(lock){
      document.body.classList.toggle('modal-open', !!lock);
      if (sheet1) sheet1.inert = !!lock;  // evita foco/gestos atrás (si el navegador soporta)
      if (pageMain) pageMain.inert = !!lock;
      if (pageHeader) pageHeader.inert = !!lock;
      document.getElementById('overlay')?.classList.toggle('show', !!lock);
    }

    // Observa apertura/cierre del editor
    new MutationObserver(() => {
      const open = !editorSheet.hasAttribute('hidden');
      lockBackground(open);
      if (open) setTimeout(measureFooter, 50);
    }).observe(editorSheet, { attributes: true, attributeFilter: ['hidden','class'] });

    // ===== Orientación física real =====
    function isPhysicalLandscape() {
      try {
        if (screen.orientation && typeof screen.orientation.type === 'string') {
          return screen.orientation.type.startsWith('landscape');
        }
        if (typeof screen.orientation?.angle === 'number') {
          return Math.abs(screen.orientation.angle) === 90;
        }
      } catch (_) {}
      if (typeof window.orientation === 'number') return Math.abs(window.orientation) === 90;
      if (typeof screen.width === 'number' && typeof screen.height === 'number') return screen.width > screen.height;
      try { return !!window.matchMedia && window.matchMedia('(orientation: landscape)').matches; } catch (_) { return false; }
    }

    function applyOrientationLock() {
      const landscape = isPhysicalLandscape();
      if (landscape) {
        html.classList.add('landscape-touch');
        overlay && overlay.setAttribute('aria-hidden', 'false');
      } else {
        html.classList.remove('landscape-touch');
        overlay && overlay.setAttribute('aria-hidden', 'true');
      }
    }

    // ===== Footer metrics + teclado =====
    function measureFooter(){
      const f = editorSheet.querySelector('.actions-footer');
      const h = Math.max(60, f ? (f.offsetHeight || 0) : 0);
      html.style.setProperty('--footer-h', h + 'px');
    }

    function setupKeyboardSafeArea() {
      if (!('visualViewport' in window) || !window.visualViewport) return;
      const vv = window.visualViewport;
      let t;
      const updateKb = () => {
        const active = document.activeElement;
        const tag = (active?.tagName || '').toUpperCase();
        const isField = tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT';

        const shrink = (window.innerHeight || 0) - (vv.height || 0);
        // iOS numpad a veces reporta shrink bajo: forzamos abierto si input tipo tel/number
        const isNumericField = isField && (
          active.type === 'tel' ||
          active.type === 'number' ||
          active.inputMode === 'numeric' ||
          active.inputMode === 'tel'
        );

        const kbPx = Math.max(0, shrink);
        const open = kbPx > 24 || (isNumericField && kbPx >= 0); // fuerza estado en numpad iOS/Android

        html.style.setProperty('--kb-safe', open ? (kbPx + 'px') : '0px');
        editorSheet.classList.toggle('kb-open', open);
        measureFooter();
      };
      updateKb();
      vv.addEventListener('resize', () => { clearTimeout(t); t = setTimeout(updateKb, 40); }, { passive: true });
      vv.addEventListener('scroll',  () => { clearTimeout(t); t = setTimeout(updateKb, 40); }, { passive: true });
      window.addEventListener('focusin', updateKb, { passive:true });
      window.addEventListener('focusout', () => { setTimeout(updateKb, 40); }, { passive:true });
    }

    // ===== Auto-scroll al enfocar campos (sin empujar botones) =====
    (function focusScroll(){
      const scrollBox = editorSheet.querySelector('.sheet-scroll');
      if (!scrollBox) return;
      function ensureInView(el){
        try{
          const r = el.getBoundingClientRect();
          const box = scrollBox.getBoundingClientRect();
          const padTop = 10;
          const padBottom = 16 + parseInt(getComputedStyle(document.documentElement).getPropertyValue('--footer-h')) + parseInt(getComputedStyle(document.documentElement).getPropertyValue('--kb-safe'));
          if (r.top < box.top + padTop) {
            scrollBox.scrollBy({ top: r.top - box.top - padTop, behavior:'smooth' });
          } else if (r.bottom > box.bottom - padBottom) {
            scrollBox.scrollBy({ top: r.bottom - (box.bottom - padBottom), behavior:'smooth' });
          }
        }catch(_){}
      }
      scrollBox.addEventListener('focusin', e=>{
        const t = e.target;
        if (!t) return;
        const tag = (t.tagName||'').toUpperCase();
        if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT'){
          setTimeout(()=>ensureInView(t), 35);
        }
      }, { passive:true });
    })();

    // ===== Estado inicial / listeners =====
    applyOrientationLock();
    setupKeyboardSafeArea();
    window.addEventListener('pageshow', () => { applyOrientationLock(); measureFooter(); }, { passive:true });

    const safeApply = () => setTimeout(applyOrientationLock, 0);
    screen.orientation?.addEventListener?.('change', safeApply, { passive: true });
    window.addEventListener('orientationchange', safeApply, { passive: true });
    window.addEventListener('resize', safeApply, { passive: true });
    document.addEventListener('visibilitychange', () => { if (!document.hidden) safeApply(); }, { passive: true });
  })();
  </script>
</body>
</html>

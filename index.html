<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Order & Items</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover">
  <link rel="preconnect" href="https://script.google.com" crossorigin>
  <link rel="preconnect" href="https://www.google.com" crossorigin>
  <link rel="preconnect" href="https://ssl.gstatic.com" crossorigin>
  <link rel="dns-prefetch" href="https://script.google.com">
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <!-- Rotate Overlay -->
  <div id="rotate-overlay" role="dialog" aria-live="assertive" aria-hidden="true">
    <div class="rotate-card" role="document">
      <svg class="phone-icon" viewBox="0 0 64 64" aria-hidden="true">
        <rect x="16" y="8" width="32" height="48" rx="6" ry="6" fill="none" stroke="currentColor" stroke-width="3"></rect>
        <rect x="20" y="12" width="24" height="40" rx="3" ry="3" fill="currentColor" opacity="0.12"></rect>
        <g class="rotate-arrow">
          <path d="M38 54a18 18 0 1 1 12-5" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round"></path>
          <polyline points="49,44 51,53 42,51" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"></polyline>
        </g>
      </svg>
      <div class="rotate-title">ROTATE TO PORTRAIT</div>
      <div class="rotate-hint">This app works in portrait mode only.</div>
    </div>
  </div>

  <!-- Boot overlay -->
  <div id="bootMask" class="boot-mask" aria-live="polite">
    <div class="boot-card">
      <div class="dots" aria-hidden="true"><span></span><span></span><span></span></div>
      <div class="boot-text">Loading…</div>
      <div class="boot-sub">Preparing order and items</div>
    </div>
  </div>

  <header id="top">
    <div class="title" id="clientName">Loading…</div>
    <div class="subtitle" id="orderInfo"></div>
  </header>

  <main>
    <section id="itemsGrid" class="grid"></section>
    <div id="empty" class="empty" hidden>No data for that order.</div>
  </main>

  <!-- SHEET 1: LIST -->
  <div id="overlay" class="overlay" hidden></div>
  <section id="sheet" class="sheet" role="dialog" aria-modal="true" aria-labelledby="sheetTitle" hidden>
    <div class="sheet__header">
      <button id="sheetBack" class="sheet__back" aria-label="Back">←</button>
      <div class="sheet__title" id="sheetTitle">Selected Item</div>
    </div>
    <div class="sheet__body sheet1-body">
      <button id="btnAdd" class="cta">Add</button>
      <div id="summary" class="summary" aria-live="polite">
        <div><b>Total players:</b> 0</div>
        <div id="summarySizes">Sizes: —</div>
      </div>
      <div id="list" class="list" role="list"></div>
    </div>
  </section>

  <!-- SHEET 2: EDITOR -->
  <div id="overlay2" class="overlay overlay-strong" hidden></div>
  <section id="editorSheet" class="sheet sheet-editor" role="dialog" aria-modal="true" hidden>
    <div class="sheet__body editor-body">
      <div class="editor-inner">
        <div class="field">
          <label for="ePlayer">Player</label>
          <input id="ePlayer" class="input" type="text" placeholder="Enter player name">
        </div>

        <div class="field">
          <label for="eCategory">Category</label>
          <select id="eCategory" class="select">
            <option value="">Select…</option>
            <option value="YOUTH">Youth</option>
            <option value="ADULT">Adult</option>
            <option value="WOMEN">Women</option>
            <option value="STANDARD">Standard</option>
          </select>
        </div>

        <div id="eSizeField" class="field" hidden>
          <label>Size</label>
          <div id="eSizes" class="size-row" role="radiogroup" aria-label="Size"></div>
        </div>

        <div class="field">
          <label for="eNumber">Number</label>
          <input id="eNumber" class="input" type="tel" inputmode="numeric" pattern="[0-9]*" placeholder="e.g., 28">
        </div>

        <div class="field">
          <label for="eName">Name</label>
          <input id="eName" class="input" type="text" placeholder="Custom name">
        </div>

        <div class="field">
          <label>Units</label>
          <div class="qty" role="group" aria-label="Units">
            <button id="qMinus" class="qty__btn" aria-label="Decrease">−</button>
            <input id="eUnits" class="qty__input" type="tel" inputmode="numeric" pattern="[0-9]*" min="1" max="100" value="1">
            <button id="qPlus" class="qty__btn" aria-label="Increase">+</button>
          </div>
        </div>
      </div>
    </div>

    <div class="actions-footer">
      <div class="actions-inner">
        <div class="actions-row">
          <button id="eDelete" class="action danger" hidden>Delete</button>
        </div>
        <div class="actions-row two">
          <button id="eSave" class="action primary">Save</button>
          <button id="eCancel" class="action">Cancel</button>
        </div>
      </div>
    </div>
  </section>

  <script defer src="app.js"></script>

  <!-- ROTATE + KEYBOARD (con histeresis y freeze) -->
  <script>
  (function () {
    const html        = document.documentElement;
    const overlay     = document.getElementById('rotate-overlay');
    const editorSheet = document.getElementById('editorSheet');

    function isPhysicalLandscape() {
      try {
        if (screen.orientation && typeof screen.orientation.type === 'string') return screen.orientation.type.startsWith('landscape');
        if (typeof screen.orientation?.angle === 'number') return Math.abs(screen.orientation.angle) === 90;
      } catch(_) {}
      if (typeof window.orientation === 'number') return Math.abs(window.orientation) === 90;
      if (typeof screen.width === 'number' && typeof screen.height === 'number') return screen.width > screen.height;
      try { return !!window.matchMedia && window.matchMedia('(orientation: landscape)').matches; } catch(_) { return false; }
    }

    function applyOrientationLock() {
      const landscape = isPhysicalLandscape();
      if (landscape) {
        html.classList.add('landscape-touch');
        overlay && overlay.setAttribute('aria-hidden', 'false');
      } else {
        html.classList.remove('landscape-touch');
        overlay && overlay.setAttribute('aria-hidden', 'true');
      }
    }

    function measureFooter(){
      const f = document.querySelector('#editorSheet .actions-footer');
      const h = Math.max(60, f ? (f.offsetHeight || 0) : 0);
      html.style.setProperty('--footer-h', h + 'px');
    }

    // =================== setupKeyboardSafeArea con histeresis + freeze ===================
    (function setupKeyboardSafeArea(){
      const VV = window.visualViewport;
      if (!VV) return;

      let lastApplied = 0;
      let lastSample  = 0;
      let stableCount = 0;
      let ticking     = false;

      function computeKb(){
        const innerH = window.innerHeight || 0;
        const vvH    = VV.height || innerH;
        const vvTop  = VV.offsetTop || 0; // iOS offset con teclado
        return Math.max(0, innerH - (vvH + vvTop));
      }

      function apply(kb){
        html.style.setProperty('--kb-safe', (kb>0? kb : 0) + 'px');
        if (editorSheet) editorSheet.classList.toggle('kb-open', kb > 0);
        measureFooter();
        lastApplied = kb;
      }

      function freezeFooterFor(ms){
        const cs = getComputedStyle(html).getPropertyValue('--kb-safe').trim();
        html.style.setProperty('--footer-bottom-freeze', cs || '0px');
        html.classList.add('footer-freeze');
        setTimeout(()=>{ html.classList.remove('footer-freeze'); }, ms);
      }

      function sample(){
        const kb = computeKb();
        const kbRounded = Math.max(0, Math.round(kb / 2) * 2); // evita ruido subpíxel

        if (kbRounded === lastSample) {
          stableCount++;
        } else {
          stableCount = 1;
          lastSample  = kbRounded;
        }

        const isOpening = kbRounded > lastApplied;
        const isClosing = kbRounded < lastApplied;

        if (isOpening) {
          apply(kbRounded); // apertura: inmediato
        } else if (isClosing) {
          if (stableCount === 1) {
            freezeFooterFor(180); // primera lectura de cierre
          }
          if (stableCount >= 2) {
            apply(kbRounded); // espera 2 frames estables
          }
        }
        ticking = false;
      }

      function requestSample(){
        if (ticking) return;
        ticking = true;
        requestAnimationFrame(()=>requestAnimationFrame(sample)); // 2 RAF
      }

      // Primer layout “bueno”
      requestSample();
      setTimeout(requestSample, 160);

      // Eventos relevantes
      VV.addEventListener('resize', requestSample, {passive:true});
      VV.addEventListener('scroll',  requestSample, {passive:true});
      window.addEventListener('focusin',  requestSample, {passive:true});
      window.addEventListener('focusout', requestSample, {passive:true});
      window.addEventListener('orientationchange', ()=>{ setTimeout(requestSample, 180); }, {passive:true});
      window.addEventListener('pageshow', requestSample, {passive:true});
    })();

    // Observar apertura/cierre del editor para medir footer al mostrarse
    (() => {
      if (!editorSheet) return;
      const mo = new MutationObserver(() => {
        if (!editorSheet.hasAttribute('hidden')) {
          setTimeout(() => { measureFooter(); }, 50);
        }
      });
      mo.observe(editorSheet, { attributes: true, attributeFilter: ['hidden','class'] });
    })();

    applyOrientationLock();
    window.addEventListener('pageshow', () => { applyOrientationLock(); measureFooter(); }, { passive:true });

    const safeApply = () => setTimeout(applyOrientationLock, 0);
    if (screen.orientation && screen.orientation.addEventListener) {
      screen.orientation.addEventListener('change', safeApply, { passive: true });
    }
    window.addEventListener('orientationchange', safeApply, { passive: true });
    window.addEventListener('resize', safeApply, { passive: true });
    document.addEventListener('visibilitychange', () => { if (!document.hidden) safeApply(); }, { passive: true });
  })();
  </script>

  <script>
  (function(){
    const editorSheet = document.getElementById('editorSheet');
    const editorBody  = editorSheet ? editorSheet.querySelector('.editor-body') : null;
    if (!editorBody) return;

    function ensureInView(target){
      setTimeout(()=>{ try{ target.scrollIntoView({ block:'nearest', inline:'nearest', behavior:'smooth' }); }catch(_){}} , 35);
    }

    editorBody.addEventListener('focusin', (e)=>{
      const t = e.target; if (!t) return;
      const tag = (t.tagName||'').toUpperCase();
      if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT'){ ensureInView(t); }
    }, { passive:true });
  })();
  </script>

  <!-- TAP con umbral + overlay seguro -->
  <script>
  (function(){
    const $       = (s, r=document) => r.querySelector(s);
    const overlay = $('#overlay');
    const sheet   = $('#sheet');
    const grid    = $('#itemsGrid');

    if (!overlay || !sheet || !grid) return;

    function openSheet1(){
      if (sheet.classList.contains('show')) return;
      overlay.removeAttribute('hidden');
      overlay.classList.add('show');
      document.body.classList.add('modal-open');

      sheet.removeAttribute('hidden');
      sheet.classList.add('show');
    }
    function closeSheet1(){
      sheet.classList.remove('show');
      sheet.setAttribute('hidden','');
      overlay.classList.remove('show');
      overlay.setAttribute('hidden','');
      document.body.classList.remove('modal-open');
    }
    document.getElementById('sheetBack')?.addEventListener('click', closeSheet1);
    overlay.addEventListener('pointerdown', (e)=>{ e.preventDefault(); e.stopPropagation(); closeSheet1(); }, {passive:false});
    sheet.addEventListener('pointerdown', (e)=>{ e.stopPropagation(); }, {passive:true});

    const TAP_MOVE_PX = 8;
    const TAP_TIME_MS = 500;
    let active = null;

    grid.addEventListener('pointerdown', (e) => {
      const btn = e.target.closest('.btn');
      if (!btn) { active = null; return; }
      active = { id:e.pointerId, t0:performance.now(), x0:e.clientX, y0:e.clientY, btn };
    }, {passive:true});

    grid.addEventListener('pointermove', (e) => {
      if (!active || e.pointerId !== active.id) return;
      const dx = Math.abs(e.clientX - active.x0);
      const dy = Math.abs(e.clientY - active.y0);
      if (dx > TAP_MOVE_PX || dy > TAP_MOVE_PX) active.cancelled = true;
    }, {passive:true});

    grid.addEventListener('pointerup', (e) => {
      if (!active || e.pointerId !== active.id) { active = null; return; }
      const dt = performance.now() - active.t0;
      const dx = Math.abs(e.clientX - active.x0);
      const dy = Math.abs(e.clientY - active.y0);
      const sameBtn = !!e.target.closest('.btn') && e.target.closest('.btn') === active.btn;

      if (!active.cancelled && sameBtn && dt <= TAP_TIME_MS && dx <= TAP_MOVE_PX && dy <= TAP_MOVE_PX) {
        e.preventDefault(); e.stopPropagation(); openSheet1();
      }
      active = null;
    }, {passive:false});

    grid.addEventListener('pointercancel', () => { active = null; }, {passive:true});
    grid.addEventListener('click', (e) => {
      const btn = e.target.closest('.btn');
      if (!btn) return;
      if (!sheet.classList.contains('show')) openSheet1();
    });

    if (!('openSheet1' in window))  window.openSheet1  = openSheet1;
    if (!('closeSheet1' in window)) window.closeSheet1 = closeSheet1;
  })();
  </script>
</body>
</html>
